---
title: 346
author: Scarb
postid: 346
posttype: post
categories: exp
toc: true
date: 2019-11-07 23:36:41
updated: 2019-11-07 23:36:41
nicename:
tags:
---

>本文由Scarb发表于[金甲虫的博客](http://47.106.131.90/blog)，转载请注明出处

# JVM类加载机制

## 1. 类加载的时机

```flow
st=>start: 加载 Loading
op1=>operation: 验证 Verification
op2=>operation: 准备 Preparation
op3=>operation: 解析 Resolution
op4=>operation: 初始化 Initialization
op5=>operation: 使用 Using
e=>end: 卸载
st->op1->op2->op3->op4->op5->e
```

其中验证、准备、解析3个部分统称为链接（Linking）。
解析阶段在某些情况下可以在初始化阶段之后再开始，这是为了支持Java语言的运行时绑定。

虚拟机规范严格规定有且仅有5种情况必须立即对类进行初始化。
类进行初始化的5种情况，称为主动引用

1. 遇到new、getstatic、putstatic、invokestatic这4条字节码指令。场景：使用`new`实例化对象、读取或设置一个类的静态字段、调用一个类的静态方法时。
2. 使用反射调用时
3. 初始化一个类时，先初始化父类。
4. 用户指定的主类（包含`main()`方法）
5. 使用JDK 1.7动态语言支持，一个`java.lang.invoke.MethodHandle`实力最后解析结果REF_getStatic、REF_pubStatic、REF_invokeStatic的方法句柄。

## 2. 类加载的过程

### 2.1 加载

加载阶段，虚拟机完成3件事情。

1. 通过一个类的全限定名获取定义此类的二进制字节流。
2. 讲这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。
3. 在内存中生成一个代表这个类的`java.lang.Class`对象，作为方法区这个类的各种数据的访问入口。

* 非数组类的加载阶段可控性强，可以用系统或者自动以的类加载器去完成。（重写`loadClass()`）
* 数组类不通过类加载器创建，由Java虚拟机直接创建。数组类的元素类型最终靠类加载器创建。
  * 如果数组的组件类型是引用类型，递归采用加载过程去加载该组件类型。
  * 如果组件类型不是引用类型，Java虚拟机将会把数据标记为与引导类加载器关联。
  * 数组类的可见性与它的组件类型的可见性一致，如果组件类型不是引用类型，那数组类可见性默认为public

加载阶段与连接阶段部分内容交叉进行，但在加载阶段中进行的动作仍然属于连接阶段，这两个阶段的开始时间仍然保持固定的先后顺序。

### 2.2 验证

连接阶段第一步

为了确保Class文件的字节流种包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。

#### 2.2.1 文件格式验证

字节流是否符合Class文件格式的规范，并且能被当前版本的虚拟机处理。

#### 2.2.2 元数据验证

对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范的要求。

* 类是否有父类
* 父类是否继承了不允许被继承的类
* 如果不是抽象类，是否实现了父类或接口中要求实现的所有方法
* 字段、方法是否与父类发生矛盾

#### 2.2.3 字节码验证

通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。

* 保证任务时刻操作数栈的数据类型与指令代码序列都能配合工作，如：在操作栈防止一个int类型数据，使用时按long类型加载如本地变量表中。
* 保证跳转指令不会跳转到方法体以外的字节码指令上。
* 保证方法体中的类型转换是有效的。

#### 2.2.4 符号引用验证

发生在虚拟机讲符号引用转化为直接引用的时候，这个转化动作将在连接的第三阶段——解析阶段中发生。

可以看做是对类自身以外的信息进行匹配性校验。

### 2.3 准备

正式为类变量分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在方法区中进行分配。

* 此时进行内存分配的仅包括类变量（`static`修饰的变量），而不包括实例变量。实例变量将会在对象实例化时随着对象一起分配在Java堆中。
* 初始值通常情况下是数据类型的零值。
  * `public static int value = 123` 经过准备阶段后初始值为0而不是123，因为此时尚未开始执行任何Java方法。而把`value`赋值为123的动作在初始化阶段才会执行。
  * 特殊情况：如果类字段是常量，那在准备阶段变量`value`就会被初始化为常量属性指定的值
    * `public static final int value = 123`，在准备阶段`value`就会赋值为123。

### 2.4 解析

解析阶段虚拟机将常量池内的符号引用替换为直接引用。

#### 2.4.1 引用

##### 2.4.1.1 符号引用

以一组符号来描述所引用的目标。引用的目标不一定已经加载到内存中。虚拟机实现的内存布局可以不同，但它们能接受的符号引用必须都是一致的，因为符号引用的字面量形式明确定义在Java虚拟机规范的Class文件格式中。

##### 2.4.1.2 直接引用

可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。和虚拟机内存布局相关。有了直接引用，那引用的目标必定已经在内存中存在。

#### 2.4.2 解析

##### 2.4.2.1 类或接口的解析

##### 2.4.2.2 字段解析

##### 2.4.2.3 类方法解析

##### 2.4.2.4 接口方法解析

### 2.5 初始化

## 3. 类加载器

### 3.1 类与类加载器

### 3.2 双亲委派模型

### 3.3 破坏双亲委派模型
