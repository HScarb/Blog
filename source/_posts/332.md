---
title: Django REST framework manytomany relationship with extra fields DRF中有外部域的多对多关系处理
author: Scarb
postid: 332
posttype: post
categories: exp
toc: true
date: 2018-09-20 14:36:13
updated: 2018-09-20 14:36:13
nicename:
tags:
---

>本文由Scarb发表于[金甲虫的博客](http://47.106.131.90/blog)，转载请注明出处

# Django REST framework manytomany relationship with extra fields DRF中有外部域的多对多关系处理

在开发中，模型会存在多对多关系，并且多对多关系中可能会有额外的域。
这种情况下用DRF框架生成API会比较复杂，POST和PUT方法的处理也很复杂。
在这里记录一下这几天找到的一些解决方法。

## 1. 问题模型

在[Django官方文档](https://docs.djangoproject.com/en/dev/topics/db/models/#extra-fields-on-many-to-many-relationships)中提到了这种特定的问题，要使用`through`参数指定一个额外的连接模型表，这样就可以在额外的模型表中添加域。
官方文档给出的模型如下

```python
from django.db import models

class Person(models.Model):
    name = models.CharField(max_length=128)

    def __str__(self):
        return self.name

class Group(models.Model):
    name = models.CharField(max_length=128)
    members = models.ManyToManyField(Person, through='Membership')

    def __str__(self):
        return self.name

class Membership(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE)
    group = models.ForeignKey(Group, on_delete=models.CASCADE)
    date_joined = models.DateField()
    invite_reason = models.CharField(max_length=64)
```

我们可以对这些模型进行一些操作

```python
>>> ringo = Person.objects.create(name="Ringo Starr")
>>> paul = Person.objects.create(name="Paul McCartney")
>>> beatles = Group.objects.create(name="The Beatles")
>>> m1 = Membership(person=ringo, group=beatles,
...     date_joined=date(1962, 8, 16),
...     invite_reason="Needed a new drummer.")
>>> m1.save()
>>> beatles.members.all()
<QuerySet [<Person: Ringo Starr>]>
>>> ringo.group_set.all()
<QuerySet [<Group: The Beatles>]>
>>> m2 = Membership.objects.create(person=paul, group=beatles,
...     date_joined=date(1960, 8, 1),
...     invite_reason="Wanted to form a band.")
>>> beatles.members.all()
<QuerySet [<Person: Ringo Starr>, <Person: Paul McCartney>]>
```

但是不能进行以下操作，因为用指定关联表的模型会有一些限制：

```python
>>> # The following statements will not work
>>> beatles.members.add(john)
>>> beatles.members.create(name="George Harrison")
>>> beatles.members.set([john, paul, ringo, george])
```